app.controller("myGamesCtrl",["$scope","$location","$timeout","Games","Utilities","$dialog","$filter",function($scope,$location,$timeout,Games,Utilities,$dialog,$filter){var intervalID;var queryarchives;var querygames;var searchMatch;$scope.games=[];$scope.sortOrder=["startDate"];$scope.order=["startDate"];$scope.reverse=false;$scope.filteredItems=[];$scope.groupedItems=null;$scope.itemsPerPage=5;$scope.pagedItems=[];$scope.currentPage=0;$scope.isArchive=false;querygames=function(){return Games.query({},
function(data){$scope.games=data;return $scope.search()},function(error){return alert(Messages("js.errors.gameslist"))})};queryarchives=function(){return Games.archive({},function(data){$scope.games=data;return $scope.search()},function(error){return alert(Messages("js.errors.gameslist"))})};if(/\/my\/games\/archive/gi.test(window.location.pathname)){$scope.isArchive=true;queryarchives()}else querygames();$scope.showDetails=function(idx){var games;games=$scope.pagedItems[$scope.currentPage][idx];
if(games.status==="online"||games.status==="finished")window.location.pathname="/my/games/"+games.id;if(games.status==="published"||games.status==="project")return window.location.pathname="/my/games/"+games.id+"/edit"};$scope["delete"]=function(idx){var btns;var game;var msg;var title;game=$scope.pagedItems[$scope.currentPage][idx];if(game.status==="project"){title=game.name;msg=Messages("js.errors.sure","delete");btns=[{result:"no",label:Messages("js.no")},{result:"ok",label:Messages("js.yes","delete"),
cssClass:"btn-primary"}];return $dialog.messageBox(title,msg,btns).open().then(function(result){if(result==="ok")return Games["delete"]({gid:game.id},function(data){var curP;var i;i=_.indexOf($scope.games,$scope.pagedItems[$scope.currentPage][idx]);curP=$scope.currentPage;$scope.games.splice(i,1);$scope.search();return $scope.currentPage=curP},function(error){return alert(Messages("js.errors.ajax","deleting"))})})}};$scope.cancel=function(idx){var btns;var game;var msg;var title;game=$scope.pagedItems[$scope.currentPage][idx];
if(game.status==="published"){title=game.name;msg=Messages("js.errors.sure","cancel");btns=[{result:"no",label:Messages("js.no")},{result:"ok",label:Messages("js.yes","cancel"),cssClass:"btn-primary"}];return $dialog.messageBox(title,msg,btns).open().then(function(result){if(result==="ok")return Games.cancel({data:game.id},function(data){var curP;var i;i=_.indexOf($scope.games,$scope.pagedItems[$scope.currentPage][idx]);curP=$scope.currentPage;$scope.games[i].status="project";$scope.search();return $scope.currentPage=
curP},function(error){return alert(Messages("js.errors.ajax","canceling"))})})}};$scope.mtimeLeft=[];intervalID=window.setInterval(function(){var i;var _i;var _len;var _ref;_ref=$scope.pagedItems[$scope.currentPage];for(_i=0,_len=_ref.length;_i<_len;_i++){i=_ref[_i];$scope.mtimeLeft[_i]=Utilities.difference(i.startTime,i.endTime,true)}return $scope.$apply()},1E3);$scope.sortBy=function(newOrder){if($scope.sortOrder===newOrder)$scope.reverse=!$scope.reverse;$scope.sortOrder=newOrder;$("th i").each(function(){return $(this).removeClass().addClass("icon-sort")});
if($scope.reverse)$("th."+newOrder+" i").removeClass().addClass("icon-chevron-up");else $("th."+newOrder+" i").removeClass().addClass("icon-chevron-down");return $scope.search()};searchMatch=function(haystack,needle){if(!needle)return true;else return haystack.toString().toLowerCase().indexOf(needle.toLowerCase())!==-1};$scope.search=function(){$scope.filteredItems=$filter("filter")($scope.games,function(game){for(var attr in game)if(searchMatch(game[attr],$scope.query))return true;return false});
if($scope.sortOrder!=="")$scope.filteredItems=$filter("orderBy")($scope.filteredItems,$scope.sortOrder,$scope.reverse);$scope.currentPage=0;return $scope.groupToPages()};$scope.groupToPages=function(){var i;var _ref;var _results;$scope.pagedItems=[];_results=[];for(i=0,_ref=$scope.filteredItems.length-1;i<=_ref;i+=1)_results.push(i%$scope.itemsPerPage===0?$scope.pagedItems[Math.floor(i/$scope.itemsPerPage)]=[$scope.filteredItems[i]]:$scope.pagedItems[Math.floor(i/$scope.itemsPerPage)].push($scope.filteredItems[i]));
return _results};$scope.range=function(start,end){var i;var ret;var _ref;ret=[];if(!end){end=start;start=0}for(i=start,_ref=end-1;i<=_ref;i+=1)ret.push(i);return ret};$scope.prevPage=function(){if($scope.currentPage>0)return $scope.currentPage--};$scope.nextPage=function(){if($scope.currentPage<$scope.pagedItems.length-1)return $scope.currentPage++};return $scope.setPage=function(){return $scope.currentPage=this.n}}]);