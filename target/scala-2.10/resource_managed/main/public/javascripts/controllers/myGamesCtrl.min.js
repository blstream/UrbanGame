app.controller("myGamesCtrl",["$scope","$location","Games","Utilities","$filter",function($scope,$location,Games,Utilities,$filter){var clearShowed;var intervalID;var loadData;var loadGameData;var resource;var searchMatch;$scope.games=[];$scope.sortOrder=["startDate"];$scope.reverse=false;$scope.filteredItems=[];$scope.groupedItems=null;$scope.itemsPerPage=5;$scope.pagedItems=[];$scope.currentPage=0;$scope.isArchive=false;$scope.error=null;$scope.renderDetails=[];clearShowed=function(idx){var i;var _ref;
var _results;_results=[];for(i=0,_ref=$scope.games.length;0<=_ref?i<=_ref:i>=_ref;0<=_ref?i++:i--)_results.push(i!==idx?$scope.renderDetails[i]=false:void 0);return _results};resource={"querygames":function(){return Games.query({},function(data){$scope.games=data;$scope.search();return clearShowed()},function(error){return $scope.error=Messages("js.errors.gameslist")})},"queryarchives":function(){return Games.archive({},function(data){$scope.games=data;return $scope.search()},function(error){return $scope.error=
Messages("js.errors.gameslist")})},"delete":function(idx){var game;game=$scope.pagedItems[$scope.currentPage][idx];return Games["delete"]({gid:game.id},function(data){var curP;var i;i=_.indexOf($scope.games,game);curP=$scope.currentPage;$scope.games.splice(i,1);$scope.search();return $scope.currentPage=curP},function(error){return $scope.error=Messages("js.errors.ajax","deleting")})},"cancel":function(idx){var game;game=$scope.pagedItems[$scope.currentPage][idx];return Games.cancel({data:game.id},
function(data){var curP;var i;i=_.indexOf($scope.games,game);curP=$scope.currentPage;$scope.games[i].status="project";$scope.search();return $scope.currentPage=curP},function(error){return $scope.error=Messages("js.errors.ajax","canceling")})}};$scope.menu=[{no:0,title:Messages("menu.gameinfo"),icon:"icon-info-sign"},{no:1,title:Messages("menu.players"),icon:"icon-user"},{no:2,title:Messages("menu.tasks"),icon:"icon-list-alt"},{no:3,title:Messages("menu.gameskin"),icon:"icon-eye-open"},{no:4,title:Messages("menu.messages"),
icon:"icon-envelope-alt"},{no:5,title:Messages("menu.backto.mygames"),icon:"icon-arrow-left"}];$scope.selection=$scope.menu[0];$scope.goTo=function(idx){var cur;cur=$scope.menu[idx];loadData[idx]();return $scope.selection=cur};if(/\/my\/games\/archive/gi.test(window.location.pathname)){$scope.isArchive=true;resource["queryarchives"]()}else resource["querygames"]();$scope.showDetails=function(idx){var games;games=$scope.pagedItems[$scope.currentPage][idx];if(games.status==="online"||games.status===
"finished"){clearShowed(idx);$scope.renderDetails[idx]=!$scope.renderDetails[idx];if($scope.renderDetails[idx]===true)$scope.goTo($scope.selection.no)}if(games.status==="published"||games.status==="project")return window.location.pathname="/my/games/"+games.id+"/edit"};$scope["delete"]=function(idx){var action;var game;game=$scope.pagedItems[$scope.currentPage][idx];action="delete";if(game.status==="project")return Utilities.showDialog(game.name,action).then(function(result){if(result==="ok")return resource[action](idx)})};
$scope.cancel=function(idx){var action;var game;game=$scope.pagedItems[$scope.currentPage][idx];action="cancel";if(game.status==="published")return Utilities.showDialog(game.name,action).then(function(result){if(result==="ok")return resource[action](idx)})};$scope.mtimeLeft=[];intervalID=window.setInterval(function(){var i;var _i;var _len;var _ref;if(!_.isUndefined($scope.pagedItems[$scope.currentPage])){_ref=$scope.pagedItems[$scope.currentPage];for(_i=0,_len=_ref.length;_i<_len;_i++){i=_ref[_i];
$scope.mtimeLeft[_i]=Utilities.difference(i.startTime,i.endTime,true)}}return $scope.$apply()},1E3);$scope.sortBy=function(newOrder){if($scope.sortOrder===newOrder)$scope.reverse=!$scope.reverse;$scope.sortOrder=newOrder;$("th i").each(function(){return $(this).removeClass().addClass("icon-sort")});if($scope.reverse)$("th."+newOrder+" i").removeClass().addClass("icon-chevron-up");else $("th."+newOrder+" i").removeClass().addClass("icon-chevron-down");return $scope.search()};searchMatch=function(haystack,
needle){if(!needle)return true;else return haystack.toString().toLowerCase().indexOf(needle.toLowerCase())!==-1};$scope.search=function(){$scope.filteredItems=$filter("filter")($scope.games,function(game){var attr;var res;for(attr in game)if(attr!=="endTime"&&attr!=="image"){if(attr==="startTime")res=$filter("date")(game[attr],"dd MMM yyyy HH:mm");else res=game[attr];if(searchMatch(res,$scope.query))return true}return false});if($scope.sortOrder!=="")$scope.filteredItems=$filter("orderBy")($scope.filteredItems,
$scope.sortOrder,$scope.reverse);$scope.currentPage=0;return $scope.groupToPages()};$scope.groupToPages=function(){var i;var _ref;var _results;$scope.pagedItems=[];_results=[];for(i=0,_ref=$scope.filteredItems.length-1;i<=_ref;i+=1)_results.push(i%$scope.itemsPerPage===0?$scope.pagedItems[Math.floor(i/$scope.itemsPerPage)]=[$scope.filteredItems[i]]:$scope.pagedItems[Math.floor(i/$scope.itemsPerPage)].push($scope.filteredItems[i]));return _results};$scope.range=function(start,end){var i;var ret;var _ref;
ret=[];if(!end){end=start;start=0}for(i=start,_ref=end-1;i<=_ref;i+=1)ret.push(i);return ret};$scope.prevPage=function(){if($scope.currentPage>0)return $scope.currentPage--};$scope.nextPage=function(){if($scope.currentPage<$scope.pagedItems.length-1)return $scope.currentPage++};$scope.setPage=function(){return $scope.currentPage=this.n};$scope.translate=function(code){return Messages(code)};loadData={"0":function(){var gid;gid=$scope.pagedItems[$scope.currentPage][_.indexOf($scope.renderDetails,true)].id;
return Games.get({gid:gid},function(data){return loadGameData(data)},function(error){return $scope.error=Messages("js.errors.ajax","querying")})},1:function(){},2:function(){},3:function(){},4:function(){}};loadGameData=function(data){return $scope.curgame={name:data.name,description:data.description,location:data.location,startTime:(new Date(data.startTime)).toLocaleTimeString().substring(0,5),startDate:new Date(data.startTime),endTime:(new Date(data.endTime)).toLocaleTimeString().substring(0,5),
endDate:new Date(data.endTime),winning:data.winning,winningNum:data.nWins,diff:data.difficulty,playersNum:data.maxPlayers===1E6?null:data.maxPlayers,awards:data.awards,tasksNo:data.tasksNo,status:data.status,version:data.version}};$scope.editorEnabled={"name":false,"time":false,"desc":false,"rewards":false};$scope.editName=function(){if($scope.curgame.status!=="finished"){$scope.editorEnabled["name"]=true;return $scope.ganame=$scope.curgame.name}};$scope.cancelName=function(){return $scope.editorEnabled["name"]=
false};$scope.okName=function(){if($scope.ganame==="")return false;$scope.curgame.name=$scope.ganame;return $scope.cancelName()};$scope.editTime=function(){if($scope.curgame.status!=="finished"){$scope.editorEnabled["time"]=true;return $scope.ganame=$scope.curgame.endTime}};$scope.editDesc=function(){if($scope.curgame.status!=="finished"){$scope.editorEnabled["desc"]=true;return $scope.ganame=$scope.curgame.description}};return $scope.editRewards=function(){if($scope.curgame.status!=="finished"){$scope.editorEnabled["rewards"]=
true;return $scope.ganame=$scope.curgame.awards}}}]);