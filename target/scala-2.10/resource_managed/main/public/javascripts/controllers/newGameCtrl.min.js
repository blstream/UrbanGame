var newGameCtrl;
newGameCtrl=app.controller("newGameCtrl",["$scope","$location","$route","$rootScope","Games","Utilities",function($scope,$location,$route,$rootScope,Games,Utilities){var fillGameModel;var latlngBounds;var loadModelData;var map;var overlays;var resource;var selectedCircle;var selectedMarker;var tlatlngBounds;var tmap;var toverlays;$scope.steps=[{no:1,name:Messages("js.newgame.tab.step1title")},{no:2,name:Messages("js.newgame.tab.step2title")},{no:3,name:Messages("js.newgame.tab.step3title")},{no:4,
name:Messages("js.newgame.tab.step4title")}];$scope.gameid=null;$scope.previousname=null;$scope.game={name:"",description:"",location:"",startTime:"",startDate:null,endTime:"",endDate:null,winning:"max_points",winningNum:1,diff:"easy",playersNum:null,awards:"",tasksNo:0,status:"project",version:1};$scope.tasks=[{name:"taskOne",type:"GPS",visible:"None",locations:[{lat:51.107885,lng:17.042338,radius:232},{lat:51.107885,lng:17.028538,radius:122}],version:1,maxPoints:7},{name:"taskTwo",type:"ABC",visible:"None",
version:1,maxPoints:10},{name:"taskThree",type:"GPS",visible:"None",locations:[{lat:51.10235,lng:17.042328,radius:43},{lat:51.137885,lng:17.038538,radius:222}],version:1,maxPoints:7}];$scope.task=null;$scope.skin={image:"games/gameicon.png"};$scope.error=null;$scope.editable=true;$scope.dateFormat=Messages("dateformatlong");$scope.isEdit=function(){if(/\/my\/games\/\d+\/edit/gi.test(window.location.pathname)){$scope.gameid=parseInt(/(\d+)/.exec(window.location.pathname)[1]);return true}else return false};
fillGameModel=function(){if($scope.isEdit())return resource["get"]()};loadModelData=function(data){return $scope.game={name:data.name,description:data.description,location:data.location,startTime:(new Date(data.startTime)).toLocaleTimeString().substring(0,5),startDate:new Date(data.startTime),endTime:(new Date(data.endTime)).toLocaleTimeString().substring(0,5),endDate:new Date(data.endTime),winning:data.winning,winningNum:data.nWins,diff:data.difficulty,playersNum:data.maxPlayers===1E6?null:data.maxPlayers,
awards:data.awards,tasksNo:data.tasksNo,status:data.status,version:data.version}};resource={"get":function(){return Games.get({gid:$scope.gameid},function(data){if(data.status==="published"||data.status==="project"){loadModelData(data);$scope.previousname=data.name;$scope.error=null;return $scope.editable=true}else return window.location="/my/games/"+$scope.gameid},function(error){return $scope.error=Messages("js.errors.ajax","querying")})},"publish":function(){return Games.publish({data:$scope.gameid},
function(data){return window.location="/my/games"},function(error){return $scope.error=Messages("js.errors.ajax","publishing")+" "+Messages("js.errors.aftereffects")})},"save":function(){return Games.save({data:$scope.game},function(data){$scope.gameid=data.val;if($scope.getCurrentStepIndex()===3)window.location="/my/games";$scope.selection=$scope.steps[$scope.getCurrentStepIndex()+1];return $scope.error=null},function(error){return $scope.error=Messages("js.errors.ajax","saving")})},"update":function(){return Games.update({id:$scope.gameid,
data:$scope.game},function(data){if($scope.getCurrentStepIndex()===3)window.location="/my/games";$scope.selection=$scope.steps[$scope.getCurrentStepIndex()+1];return $scope.error=null},function(error){return $scope.error=Messages("js.errors.ajax","updating")})},"checkName":function(){$("#processing").removeClass("img-ok img-error").addClass("img-processing");$scope.form.$setValidity("nameuniqueunknown",false);return Games.checkName({data:$scope.game.name},function(result){if(result.val){$("#processing").removeClass("img-processing").addClass("img-ok");
$scope.form.$setValidity("nameunique",true)}else{$("#processing").removeClass("img-processing").addClass("img-error");$scope.form.$setValidity("nameunique",false)}$scope.form.$setValidity("nameuniqueunknown",true);return $scope.error=null},function(error){return $scope.error=Messages("js.errors.name")+error})}};$scope.savegame=function(){var gid;var notSetByUser;gid=$scope.gameid;if($scope.game.playersNum===null){$scope.game.playersNum=1E6;notSetByUser=true}if(gid===null||_.isUndefined(gid))resource["save"]();
else resource["update"]();if(notSetByUser)return $scope.game.playersNum=null};$scope.publishgame=function(){var action;var gid;gid=$scope.gameid;action="publish";if(gid!==null&&!_.isUndefined(gid))return Utilities.showDialog($scope.game.name,action).then(function(result){if(result==="ok")return resource[action]()})};$scope.isValidName=function(){if($scope.gameid===null||_.isUndefined($scope.gameid)||$scope.game.name!==$scope.previousname)return resource["checkName"]()};map=null;overlays=[];latlngBounds=
null;$scope.setMap=function(){var mapOptions;mapOptions={zoom:11,center:new google.maps.LatLng(51.107885,17.038538),mapTypeId:google.maps.MapTypeId.ROADMAP};return map=new google.maps.Map(document.getElementById("gpsMap"),mapOptions)};$scope.showMarkers=function(taskIndex){var loc;var overlay;var task;var _i;var _j;var _len;var _len2;var _ref;latlngBounds=new google.maps.LatLngBounds;for(_i=0,_len=overlays.length;_i<_len;_i++){overlay=overlays[_i];overlay.setMap(null)}overlays=[];task=$scope.tasks[taskIndex];
if(task.type==="GPS"){_ref=task.locations;for(_j=0,_len2=_ref.length;_j<_len2;_j++){loc=_ref[_j];$scope.createMarker(loc,latlngBounds,overlays,map)}return map.fitBounds(latlngBounds)}else{map.setCenter(new google.maps.LatLng(51.107885,17.038538));return map.setZoom(7)}};$scope.createMarker=function(loc,latlngBounds,overlays,map){var circle;var marker;marker=new google.maps.Marker({position:new google.maps.LatLng(loc.lat,loc.lng)});circle=new google.maps.Circle({radius:loc.radius,strokeColor:"#00FF00",
strokeOpacity:1,strokeWeight:1.5,fillColor:"#00FF00",fillOpacity:0.45,center:marker.position,clickable:false});if(latlngBounds!==null)latlngBounds.extend(marker.position);overlays.push(marker);overlays.push(circle);circle.setMap(map);return marker.setMap(map)};tmap=null;toverlays=[];tlatlngBounds=null;selectedMarker=null;selectedCircle=null;$scope.setTMap=function(){var mapOptions;mapOptions={zoom:11,center:new google.maps.LatLng(51.107885,17.038538),mapTypeId:google.maps.MapTypeId.ROADMAP};tmap=
new google.maps.Map(document.getElementById("addTaskMap"),mapOptions);return google.maps.event.addListener(tmap,"click",function(event){return $scope.selectLocation(event.latLng)})};$scope.changeRadius=function(radius){if(selectedCircle!==null){selectedCircle.radius=radius;selectedCircle.setMap(null);return selectedCircle.setMap(tmap)}};$scope.selectLocation=function(latlng){var element;var radius;var scope;if(selectedMarker!==null)selectedMarker.setMap(null);if(selectedCircle!==null)selectedCircle.setMap(null);
selectedMarker=new google.maps.Marker({position:latlng,map:tmap});element=$("#radius");scope=angular.element(element).scope();radius=Number(element.val());if(!scope.radiusIsNumber||radius===0){element.val("100");radius=100;scope.radiusIsNumber=true;scope.$apply()}selectedCircle=new google.maps.Circle({radius:radius,strokeColor:"#4444FF",strokeOpacity:1,strokeWeight:1.5,fillColor:"#0000FF",fillOpacity:0.45,center:latlng,map:tmap,clickable:false});$("#latitude").val(latlng.lat());return $("#longitude").val(latlng.lng())};
$scope.repaintLocations=function(){var loc;var overlay;var _i;var _j;var _len;var _len2;var _ref;var _results;if(selectedMarker!==null)selectedMarker.setMap(null);if(selectedCircle!==null)selectedCircle.setMap(null);tlatlngBounds=new google.maps.LatLngBounds;for(_i=0,_len=toverlays.length;_i<_len;_i++){overlay=toverlays[_i];overlay.setMap(null)}toverlays=[];_ref=$scope.task.locations;_results=[];for(_j=0,_len2=_ref.length;_j<_len2;_j++){loc=_ref[_j];_results.push($scope.createMarker(loc,null,toverlays,
tmap))}return _results};$scope.selection=$scope.steps[0];$scope.getCurrentStepIndex=function(){return _.indexOf($scope.steps,$scope.selection)};$scope.isDisabled=function(index){if(index>$scope.getCurrentStepIndex()+1||$scope.form.$invalid&&index>$scope.getCurrentStepIndex())return true};$scope.isLast=function(){return!$scope.hasNextStep()};$scope.goToStep=function(index){if(!_.isUndefined($scope.steps[index])&&!$scope.isDisabled(index))return $scope.selection=$scope.steps[index]};$scope.hasNextStep=
function(){var nextStep;var stepIndex;stepIndex=$scope.getCurrentStepIndex();nextStep=stepIndex+1;return!_.isUndefined($scope.steps[nextStep])};$scope.hasPreviousStep=function(){var previousStep;var stepIndex;stepIndex=$scope.getCurrentStepIndex();previousStep=stepIndex-1;return!_.isUndefined($scope.steps[previousStep])};$scope.incrementStepIfValid=function(){if(!$scope.form.$invalid)return $scope.incrementStep()};$scope.incrementStep=function(){var nextStep;var stepIndex;if($scope.hasNextStep()){stepIndex=
$scope.getCurrentStepIndex();if(stepIndex===0){$scope.game.location=$("#locationInput").val();return $scope.savegame()}else{nextStep=stepIndex+1;return $scope.selection=$scope.steps[nextStep]}}};$scope.decrementStep=function(){var previousStep;var stepIndex;if($scope.hasPreviousStep()){stepIndex=$scope.getCurrentStepIndex();previousStep=stepIndex-1;return $scope.selection=$scope.steps[previousStep]}};$scope.incrementPlayersNum=function(){if($scope.game.playersNum===null||$scope.game.playersNum<2)return $scope.game.playersNum=
2;else return $scope.game.playersNum+=1};$scope.decrementPlayersNum=function(){if($scope.game.playersNum>2)return $scope.game.playersNum-=1;else return $scope.game.playersNum=null};$scope.incrementWinningNum=function(){if($scope.game.winningNum<1)return $scope.game.winningNum=1;else return $scope.game.winningNum+=1};$scope.decrementWinningNum=function(){if($scope.game.winningNum<=1)return $scope.game.winningNum=1;else return $scope.game.winningNum-=1};$scope.timezone="GMT"+((new Date).getTimezoneOffset()>
0?"":"+")+(new Date).getTimezoneOffset()/-60;$scope.gameduration=function(){var edate;var sdate;if(!$scope.isEdit()){sdate=new Date($scope.game.startDate.toDateString()+" "+$scope.game.startTime);edate=new Date($scope.game.endDate.toDateString()+" "+$scope.game.endTime)}else{sdate=$scope.game.startDate;edate=$scope.game.endDate}return Utilities.difference(sdate,edate,false)};$scope.getWinStrMsg=function(){if($scope.game.winning==="max_points")return Messages("newgame.gametype1");else return Messages("newgame.gametype2")};
$scope.resetDefaultTaskTemplate=function(){var additionalCond;$scope.task={type:"ABC",name:"",description:"",locations:[],maxattempts:"",maxpoints:"",penalty:"",repeat:false,answers:[{symbol:"A",text:"",points:null},{symbol:"B",text:"",points:null},{symbol:"C",text:"",points:null},{symbol:"D",text:"",points:null}]};return additionalCond=false};$scope.resetAttempts=function(){return $scope.task.maxattempts=""};$scope.addAnswer=function(){var symbol;symbol=String.fromCharCode(65+$scope.task.answers.length);
return $scope.task.answers.push({symbol:symbol,text:"",points:null,correct:true})};$scope.removeAnswer=function(index){return $scope.task.answers.splice(index,1)};$scope.addLocation=function(){var lat;var lng;var radius;lat=Number($("#latitude").val());lng=Number($("#longitude").val());radius=Number($("#radius").val());if(!isNaN(lat)&&!isNaN(lng)&&!isNaN(radius)){$scope.task.locations.push({lat:lat,lng:lng,radius:radius});return $scope.repaintLocations()}};$scope.removeLocations=function(){var i;
var options;options=document.getElementById("locationsList").options;for(i=options.length-1;i!==-1;){if(options[i].selected)$scope.task.locations.splice(i,1);i--}return $scope.repaintLocations()};$scope.additionalCond=false;$(function(){fillGameModel();return $scope.resetDefaultTaskTemplate()});return $scope.$watch("[game.winningNum, game.playersNum]",function(){if(_.isUndefined($scope.game.winningNum)||$scope.game.winningNum<1)return $scope.form.$setValidity("morewinnersthanplayers",false);else if($scope.game.playersNum!==
null)if($scope.game.playersNum>$scope.game.winningNum)return $scope.form.$setValidity("morewinnersthanplayers",true);else return $scope.form.$setValidity("morewinnersthanplayers",false);else return $scope.form.$setValidity("morewinnersthanplayers",true)},true)}]);